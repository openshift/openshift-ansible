---
- hosts: localhost
  connection: local
  sudo: True
  tasks:

  - name: create tmp dir for common /etc/hosts
    shell: mkdir -p /tmp/commonhosts

  - name: rm file
    file: path=/tmp/commonhosts/hosts state=absent

  - name: Basic /etc/hosts
    shell: echo "127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4\n::1         localhost localhost.localdomain localhost6 localhost6.localdomain6" >> /tmp/commonhosts/hosts


- hosts: couchbase_servers_hosts
  serial: 1
  gather_facts: True
  sudo: True
  tasks:

  - name: Copy /etc/hosts from localhost
    copy: src=/tmp/commonhosts/hosts dest=/etc/hosts owner=root group=root mode=0644

##TODO Mettre domaine en var
  - name: Adding node config in /etc/hosts 
    lineinfile: line="{{ ansible_default_ipv4.address }}  {{ ansible_fqdn }} {{ ansible_fqdn }}.openstack.rbox" dest=/etc/hosts 

  - name: Fetch /etc/hosts from localhost
    fetch: dest=/tmp/commonhosts/hosts src=/etc/hosts flat=yes

- hosts: couchbase_servers_hosts
  gather_facts: True
  sudo: True
  tasks:

#  - name: Install dns python
#    yum: name=python-dns state=present

  - name: Ensure bind-utils is installed, needed for nsupdate
    yum: name=bind-utils state=present

  - name: Add domain in /etc/resolv.conf if not present
    lineinfile: line="search openstack.rbox" dest=/etc/resolv.conf

  - name: Create nsupdate file
    file: path=/tmp/nsinput state=touch 

  - name: Configure nsupdate input file 
    lineinfile: line="server 10.64.109.124" dest=/tmp/nsinput 

  - name: Configure nsupdate input file 
    lineinfile: line="zone openstack.rbox" dest=/tmp/nsinput 

  - name: Configure nsupdate input file 
    lineinfile: line="update delete {{ ansible_fqdn }}." dest=/tmp/nsinput 

  - name: Configure nsupdate input file 
    lineinfile: line="update add {{ ansible_fqdn }}. 86400 A {{ public_ip }}" dest=/tmp/nsinput 

  - name: Configure nsupdate input file 
    lineinfile: line="show" dest=/tmp/nsinput 

  - name: Configure nsupdate input file 
    lineinfile: line="send" dest=/tmp/nsinput 

  - name: Show nsinput file
    shell: cat /tmp/nsinput

  - name: Update DNS with bind-utils' nsupdate
    shell: nsupdate -y "rbox.":"op9Cj64TUEPdpUL5kOcDdDZZCyZA2aE2mF8JTkM4G8BC/Ra6t5PpvyJl 079c9rgf33f2QkGsPaXUZ/jAGnzbCg==" -v /tmp/nsinput 
 
  - name: Delete nsupdate file
    file: path=/tmp/nsinput state=absent 

#  - name: update dns with ansible module
#    local_action: dnsupdate keyname="rbox."
#                  secret="op9Cj64TUEPdpUL5kOcDdDZZCyZA2aE2mF8JTkM4G8BC/Ra6t5PpvyJl 079c9rgf33f2QkGsPaXUZ/jAGnzbCg=="
#                  mname="10.64.109.124"
#                  zone="openstack.rbox."
#                  domain={{ inventory_hostname }}
#                  a={{ public_ip }}
#                  op=add

- hosts: couchbase_servers_hosts
  sudo: True
  tasks:

  - name: Copy /etc/hosts from localhost definitely
    copy: src=/tmp/commonhosts/hosts dest=/etc/hosts owner=root group=root mode=0644

- hosts: localhost
  connection: local
  sudo: True
  tasks:

  - name: Clean tmp dir for common /etc/hosts
    file: path=/tmp/commonhosts state=absent
