---
- hosts: localhost
  connection: local
  sudo: True
  tasks:

  - name: create tmp dir for common /etc/hosts
    shell: mkdir -p /tmp/commonhosts

  - name: rm file
    file: path=/tmp/commonhosts/hosts state=absent

  - name: Basic /etc/hosts
    shell: echo "127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4\n::1         localhost localhost.localdomain localhost6 localhost6.localdomain6" >> /tmp/commonhosts/hosts


- hosts: couchbase_servers_hosts
  name: Constructing common /etc/hosts file
  serial: 1
  vars_files:
  - ../vars.yml
  gather_facts: True
  sudo: True
  tasks:

  - name: Adding node config in /tmp/commonhosts/hosts a common /etc/hosts
    local_action: lineinfile line="{{ ansible_default_ipv4.address }}  {{ ansible_fqdn }} {{ ansible_fqdn }}.{{ domain }}" dest=/tmp/commonhosts/hosts

- hosts: couchbase_servers_hosts
  gather_facts: True
  vars_files:
  - ../vars.yml
  sudo: True
  tasks:

#  - name: Install dns python
#    yum: name=python-dns state=present

  - name: Ensure bind-utils is installed, needed for nsupdate
    yum: name=bind-utils state=present

  - name: Update /etc/resolv.conf
    lineinfile: line="search {{ domain }}" dest=/etc/resolv.conf

  - name: Add dns in /etc/resolv.conf
    lineinfile: line="nameserver {{ dns_server }}" dest=/etc/resolv.conf

  - name: Create nsupdate file
    file: path=/tmp/nsinput state=touch 

  - name: Configure nsupdate input file,  add dns server 
    lineinfile: line="server {{ dns_server }}" dest=/tmp/nsinput 

  - name: Configure nsupdate input file, add zone
    lineinfile: line="zone {{ domain }}" dest=/tmp/nsinput 

  - name: Configure nsupdate input file,  delete old records
    lineinfile: line="update delete {{ inventory_hostname }}.{{ domain }}." dest=/tmp/nsinput 

  - name: Configure nsupdate input file, add new record
    lineinfile: line="update add {{ inventory_hostname }}.{{ domain }}. 86400 A {{ public_ip }}" dest=/tmp/nsinput 

  - name: Configure nsupdate input file 
    lineinfile: line="show" dest=/tmp/nsinput

  - name: Configure nsupdate input file
    lineinfile: line="send" dest=/tmp/nsinput

  - name: Update DNS with bind-utils' nsupdate
    shell: nsupdate -y "{{ key }}":"{{ secret }}" -v /tmp/nsinput

  - name: Delete nsupdate file
    file: path=/tmp/nsinput state=absent 

#  - name: update dns with ansible module
#    local_action: dnsupdate keyname="rbox."
#                  secret="op9Cj64TUEPdpUL5kOcDdDZZCyZA2aE2mF8JTkM4G8BC/Ra6t5PpvyJl 079c9rgf33f2QkGsPaXUZ/jAGnzbCg=="
#                  mname="10.64.109.124"
#                  zone="openstack.rbox."
#                  domain={{ inventory_hostname }}
#                  a={{ public_ip }}
#                  op=add

- hosts: couchbase_servers_hosts
  sudo: True
  tasks:

  - name: Copy /etc/hosts from localhost definitely to each node
    copy: src=/tmp/commonhosts/hosts dest=/etc/hosts owner=root group=root mode=0644

- hosts: localhost
  connection: local
  sudo: True
  tasks:

  - name: Clean tmp dir for common /etc/hosts
    file: path=/tmp/commonhosts state=absent
