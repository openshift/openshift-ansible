---
# Included from: playbooks/byo/openshift-cluster/upgrades/v3_*/upgrade
#
# The name of this playbook could be slightly more specific in that its cleaning
# up unused docker images. So not to be accidentally confused with removing
# Image Streams within OCP.
# These tasks should try to be written without using the shell module; it seems
# that a module should be created to perform the below Docker tasks

- name: Check Docker image count
  shell: "docker images -aq | wc -l"
  register: docker_image_count
  when: docker_upgrade_nuke_images is defined and docker_upgrade_nuke_images | bool

- debug: var=docker_image_count.stdout
  when: docker_upgrade_nuke_images is defined and docker_upgrade_nuke_images | bool

- name: Remove unused Docker images for Docker 1.10+ migration
  shell: "docker rmi `docker images -aq`"
  # Will fail on images still in use:
  failed_when: false
  when: docker_upgrade_nuke_images is defined and docker_upgrade_nuke_images | bool

- name: Check Docker image count
  shell: "docker images -aq | wc -l"
  register: docker_image_count
  when: docker_upgrade_nuke_images is defined and docker_upgrade_nuke_images | bool

- debug: var=docker_image_count.stdout
  when: docker_upgrade_nuke_images is defined and docker_upgrade_nuke_images | bool
