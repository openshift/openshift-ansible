---
# We need docker service up to remove all the images, but these services will keep
# trying to re-start and thus re-pull the images we're trying to delete.
- name: Restart static master services
  command: /usr/local/bin/master-restart "{{ item }}"
  with_items:
  - api
  - controllers
  - etcd
  failed_when: false

- service:
    name: docker
    state: stopped
  register: l_pb_docker_upgrade_stop_result
  until: not (l_pb_docker_upgrade_stop_result is failed)
  retries: 3
  delay: 30

- name: Upgrade Docker
  package:
    name: "docker"
    state: latest
  register: result
  until: result is succeeded

- import_role:
    name: container_runtime
    tasks_from: docker_restart.yml
  when: not skip_docker_restart | default(False) | bool
