---
- name: Configure master instances
  hosts: oo_masters_to_config
  any_errors_fatal: true
  serial: 1
  roles:
  - role: openshift_master
    openshift_certificates_ca_host: "{{ groups.oo_first_master.0 }}"
    openshift_master_etcd_hosts: "{{ hostvars
                                     | oo_select_keys(groups['oo_etcd_to_config'] | default([]))
                                     | oo_collect('openshift.common.hostname')
                                     | default(none, true) }}"
    openshift_master_master_hosts: "{{ groups.oo_masters }}"
    openshift_infra_nodes: "{{ hostvars | oo_select_keys(groups['oo_nodes_to_config'])
                               | oo_nodes_with_label('region', 'infra')
                               | oo_collect('inventory_hostname') }}"
    openshift_nfs_hosts: "{{ groups.oo_nfs_to_config | default([]) }}"
    etcd_certificates_ca_host: "{{ groups.oo_etcd_to_config.0 }}"
    etcd_certificates_etcd_hosts: "{{ groups.oo_etcd_to_config | default([]) }}"
    etcd_certificates_hostname: "{{ openshift.common.hostname }}"
    etcd_certificates_ip: "{{ openshift.common.ip }}"
    etcd_peers: "{{ groups.oo_etcd_to_config | default([]) }}"
  - role: nickhammond.logrotate
  - role: nuage_master
    when: openshift.common.use_nuage | bool
  post_tasks:
  - name: Create group for deployment type
    group_by: key=oo_masters_deployment_type_{{ openshift.common.deployment_type }}
    changed_when: False

# Additional instance config for online deployments
- name: Additional instance config
  hosts: oo_masters_deployment_type_online
  roles:
  - pods
  - os_env_extras
