---
- name: Create dns nsupdate or hosts files for admin use
  hosts: localhost
  tasks:
    - import_role:
        name: openshift_rhv
        tasks_from: build_vm_list.yml
    - name: Log in to oVirt
      ovirt_auth:
        url: "{{ ovirt_engine_url }}"
        username: "{{ ovirt_engine_user }}"
        password: "{{ ovirt_engine_password }}"
        ca_file: "{{ ovirt_engine_cafile | default(omit) }}"
        insecure: "{{ ovirt_engine_insecure | default(true) }}"
    - import_role:
        name: oVirt.vm-infra
        tasks_from: create_inventory.yml
    - name: Logout from oVirt
      ovirt_auth:
        state: absent
        ovirt_auth: "{{ ovirt_auth }}"
    - import_role:
        name: openshift_rhv
        tasks_from: generate_nsupdate.yml
      when:
        - openshift_rhv_nsupdate_server is defined
        - openshift_rhv_nsupdate_key is defined
    - nsupdate:
        key_name: "{{ openshift_rhv_nsupdate_key.name }}"
        key_secret: "{{ openshift_rhv_nsupdate_key.secret }}"
        server: "{{ openshift_rhv_nsupdate_server }}"
        zone: "{{ item.zone }}"
        record: "{{ item.record }}"
        value: "{{ item.value }}"
        type: "{{ item.type|default(omit) }}"
      with_items:
        - "{{ records }}"
      when:
        - openshift_rhv_nsupdate_server is defined
        - openshift_rhv_nsupdate_key is defined
    - import_role:
        name: openshift_rhv
        tasks_from: generate_hostfile.yml
      when: openshift_rhv_nsupdate_server is not defined
