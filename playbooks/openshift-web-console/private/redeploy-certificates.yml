---

- name: Update web console certificates
  hosts: oo_first_master
  vars:
  roles:
  - lib_openshift
  - openshift_facts
  tasks:
  - name: Remove certificates secret in openshift-web-console
      shell: oc delete secret console-serving-cert -n openshift-console

  - name: Remove web console pods
      shell: oc delete pods --all -n openshift-console

  - name: Verify that the console is running
    oc_obj:
      namespace: openshift-console
      kind: deployment
      state: list
      name: console
    register: console_deployment
    until:
    - console_deployment.results.results[0].status.readyReplicas is defined
    - console_deployment.results.results[0].status.readyReplicas > 0
    retries: 60
    delay: 10
    changed_when: false

  - name: Remove certificates secret in openshift-web-console
      shell: oc delete secret webconsole-serving-cert -n openshift-web-console

  - name: Remove web console pods
      shell: oc delete pods --all -n openshift-web-console

  - name: Verify that the console is running
    oc_obj:
      namespace: openshift-web-console
      kind: deployment
      state: list
      name: webconsole
    register: webconsole_deployment
    until:
    - webconsole_deployment.results.results[0].status.readyReplicas is defined
    - webconsole_deployment.results.results[0].status.readyReplicas > 0
    retries: 60
    delay: 10
    changed_when: false
