---
- name: Launch instance(s)
  hosts: localhost
  connection: local
  gather_facts: no

  vars:
    inst_region: "{{ oo_aws_region | default('us-east-1') }}"
    user_data_file: user_data.txt

  vars_files:
    - vars.yml

  tasks:
    - name: Launch instances
      ec2:
        state: present
        region: "{{ inst_region }}"
        keypair: "{{ oo_aws_keypair | default('libra') }}"
        group: ['public']
        instance_type: "{{ oo_aws_instance_type | default('m3.large') }}"
        image: "{{ oo_aws_ami | default('ami-86781fee') }}"
        count: "{{ oo_new_inst_names | oo_len }}"
        user_data: "{{ lookup('file', user_data_file) }}"
        wait: yes
      register: ec2

    - name: Add new instances public IPs to the atomic proxy host group
      add_host: "hostname={{ item.public_ip }} groupname=new_ec2_instances"
      with_items: ec2.instances

    - name: Add Name and environment tags to instances
      ec2_tag: "resource={{ item.1.id }} region={{ inst_region }} state=present"
      with_together:
        - oo_new_inst_names
        - ec2.instances
      args:
        tags:
          Name: "{{ item.0 }}"

    - name: Add other tags to instances
      ec2_tag: "resource={{ item.id }} region={{ inst_region }} state=present"
      with_items: ec2.instances
      args:
        tags: "{{ oo_new_inst_tags }}"

    - name: Add new instances public IPs to oo_hosts_to_config
      add_host:
        hostname: "{{ item.0 }}"
        ansible_ssh_host: "{{ item.1.dns_name }}"
        oo_minion_index: "{{ item.2 }}"
        oo_nb_new_inst: "{{ oo_new_inst_names | count }}"
        groupname: oo_hosts_to_config
      with_together:
        - oo_new_inst_names
        - ec2.instances
        - oo_indexes

    - debug: var=ec2

    - name: Wait for ssh
      wait_for: "port=22 host={{ item.dns_name }}"
      with_items: ec2.instances

    - name: Wait for root user setup
      command: "ssh -o StrictHostKeyChecking=no -o PasswordAuthentication=no -o ConnectTimeout=10 -o UserKnownHostsFile=/dev/null root@{{ item.dns_name }} echo root user is setup"
      register: result
      until: result.rc == 0
      retries: 20
      delay: 10
      with_items: ec2.instances

- name: "Force fact gathering"
  hosts: "tag_env-host-type_{{ oo_env }}-openshift-minion"
  connection: ssh
  user: root
  tasks:
    - name: Gather fact
      setup: filter=ansible_local

- name: "Configure instances"
  hosts: oo_hosts_to_config
  connection: ssh
  user: root
  vars_files:
    - vars.yml
  roles:
    - { role: ../../../roles/minion_indices,
        oo_minion_subnet_index: "{%if 'tag_env-host-type_' + oo_env + '-openshift-minion' in groups %}{{ ( oo_minion_index | int ) + ( hostvars | oo_select_keys( groups[ 'tag_env-host-type_' + oo_env + '-openshift-minion' ] ) | oo_collect('ansible_local') | oo_collect('minion') | oo_collect('minion') | oo_collect('nb_minions') | map('int') | max ) }}{% else %}{{ oo_minion_index }}{% endif %}",
        oo_nb_minions:          "{%if 'tag_env-host-type_' + oo_env + '-openshift-minion' in groups %}{{ ( oo_nb_new_inst  | int ) + ( hostvars | oo_select_keys( groups[ 'tag_env-host-type_' + oo_env + '-openshift-minion' ] ) | oo_collect('ansible_local') | oo_collect('minion') | oo_collect('minion') | oo_collect('nb_minions') | map('int') | max ) }}{% else %}{{ oo_nb_new_inst  }}{% endif %}"
        }

# Apply the configs, seprate so that just the configs can be run by themselves
- include: config.yml
