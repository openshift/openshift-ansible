---
- name: create custom node scale group
  hosts: localhost
  connection: local
  gather_facts: yes
  tasks:
  - name: Alert user to variables needed - clusterid
    debug:
      msg: "openshift_aws_clusterid={{ openshift_aws_clusterid | default('default') }}"

  - name: Alert user to variables needed - region
    debug:
      msg: "openshift_aws_region={{ openshift_aws_region | default('us-east-1') }}"

  - name: create the node groups
    include_role:
      name: openshift_aws
      tasks_from: provision_custom_nodes.yml
    vars:
      openshift_aws_launch_config_name: "{{ openshift_aws_clusterid }}-{{ openshift_aws_node_group_type }}-{{ ansible_date_time.epoch }}"
      openshift_aws_scale_group_name: "{{ openshift_aws_clusterid }} openshift {{ openshift_aws_node_group_type }}"
      openshift_aws_node_security_groups:
        default:
          name: "{{ openshift_aws_clusterid }}"
          desc: "{{ openshift_aws_clusterid }} default"
          rules:
          - proto: tcp
            from_port: 22
            to_port: 22
            cidr_ip: 0.0.0.0/0
          - proto: all
            from_port: all
            to_port: all
            group_name: "{{ openshift_aws_clusterid }}"

        compute-crio:
          name: "{{ openshift_aws_clusterid }}_compute"
          desc: "{{ openshift_aws_clusterid }} compute node instances"

      openshift_aws_node_group_config:
        tags: "{{ openshift_aws_node_group_config_tags }}"
        compute-crio:
          instance_type: m4.xlarge
          ami: "{{ openshift_aws_ami }}"
          volumes:
          - device_name: /dev/sdb
            volume_size: 100
            device_type: gp2
            delete_on_termination: True
          health_check:
            period: 60
            type: EC2
          min_size: 3
          max_size: 3
          desired_size: 3
          tags:
            host-type: node
            sub-host-type: compute-crio
          labels:
            type: compute-crio
          wait_for_instances: True
          termination_policy: Default
          replace_all_instances: False
