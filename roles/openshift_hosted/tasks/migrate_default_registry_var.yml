---

# This work is to migrate the OPENSHIFT_DEFAULT_REGISTRY variable
# inside of the docker-registry's dc to REGISTRY_OPENSHIFT_SERVER_ADDR.
- name: fetch env vars
  oc_obj:
    state: list
    namespace: default
    kind: dc
    name: docker-registry
  register: dc

- debug:
    msg: "{{ dc.results.results[0]  }}"

- set_fact:
    env_vars: "{{ dc.results.results[0].spec.template.spec.containers[0] | json_query(\"env[?name!='OPENSHIFT_DEFAULT_REGISTRY']\") | union([{'name': 'REGISTRY_OPENSHIFT_SERVER_ADDR', 'value': openshift_hosted_default_registry_url }]) }}"

- name: remove env vars
  oc_edit:
    name: docker-registry
    kind: dc
    edits:
    - key: spec.template.spec.containers[0].env
      value: "{{ env_vars }}"
  register: output
