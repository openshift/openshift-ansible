---
- name: Abort if a cluster ID is not specified
  when:
    - openshift_cloudprovider_aws_cluster_id | default('') == ''
    - not openshift_cloudprovider_aws_single_cluster | default(false,true) | bool
  fail:
    msg: |-
      When configuring the AWS cloud provider you must either set
      openshift_cloudprovider_aws_cluster_id to a unique value per cluster and
      that your instances are labeled with "kubernetes.io/cluster/xxxx=openshift_cloudprovider_aws_cluster_id"
      where xxxx is a unique string and openshift_cloudprovider_aws_cluster_id
      is the value of the aforementioned variable. If you've only got one cluster
      per AWS account you must set openshift_cloudprovider_aws_single_cluster=true
      to override this check.

# Work around ini_file create option in 2.2 which defaults to no
- name: Create cloud config file
  file:
    dest: "{{ openshift.common.config_base }}/cloudprovider/aws.conf"
    state: touch
    mode: 0660
    owner: root
    group: root
  changed_when: false

- name: Configure AWS cloud provider
  ini_file:
    dest: "{{ openshift.common.config_base }}/cloudprovider/aws.conf"
    section: Global
    option: Zone
    value: "{{ openshift.provider.zone }}"

- when:
  - not openshift_cloudprovider_aws_single_cluster | default(false,true) | bool
  block:
  # 3.6 and newer use KubernetesClusterID
  - name: Configure AWS KubernetesClusterID
    ini_file:
      dest: "{{ openshift.common.config_base }}/cloudprovider/aws.conf"
      section: Global
      option: KubernetesClusterID
      value: "{{ openshift_cloudprovider_aws_cluster_id }}"

  # 3.5 and older use KubernetesClusterTag
  - name: Configure AWS KubernetesClusterTag
    ini_file:
      dest: "{{ openshift.common.config_base }}/cloudprovider/aws.conf"
      section: Global
      option: KubernetesClusterTag
      value: "{{ openshift_cloudprovider_aws_cluster_id }}"
