---
- when:
  - docker_registry is not defined
  - inventory_hostname == contrail_first_master

  block:
  - name: Untar Contrail tar-file
    unarchive:
      src: "{{ contrail_docker_images_path }}/contrail-kubernetes-docker-images_{{ contrail_version }}.tgz"
      dest: "/tmp"

  - name: Load Contrail-Controller image
    docker_image:
      name: contrail-controller
      tag: "{{ contrail_version }}"
      timeout: 300
      state: present
      load_path: "/tmp/contrail-controller-{{ contrail_os_release }}-{{ contrail_version }}.tar.gz"

  - name: Load Contrail-Analytics image
    docker_image:
      name: contrail-analytics
      tag: "{{ contrail_version }}"
      timeout: 300
      state: present
      load_path: "/tmp/contrail-analytics-{{ contrail_os_release }}-{{ contrail_version }}.tar.gz"

  - name: Load Contrail-Analytics-DB image
    docker_image:
      name: contrail-analyticsdb
      tag: "{{ contrail_version }}"
      timeout: 300
      state: present
      load_path: "/tmp/contrail-analyticsdb-{{ contrail_os_release }}-{{ contrail_version }}.tar.gz"

  - name: Load Contrail-Kube-Manager image
    docker_image:
      name: contrail-kube-manager
      tag: "{{ contrail_version }}"
      timeout: 300
      state: present
      load_path: "/tmp/contrail-kube-manager-{{ contrail_os_release }}-{{ contrail_version }}.tar.gz"

  - name: Create Contrail single YAML file
    become: yes
    template:
      src: contrail-installer.j2
      dest: /tmp/contrail-installer.yaml
      owner: root
      mode: 0644
