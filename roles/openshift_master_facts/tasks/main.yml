---
- name: Check for RPM generated config marker file .config_managed
  stat:
    path: /etc/origin/.config_managed
  register: rpmgenerated_config

- name: Remove RPM generated config files if present
  file:
    path: "/etc/origin/{{ item }}"
    state: absent
  when: rpmgenerated_config.stat.exists == true and deployment_type in ['openshift-enterprise', 'atomic-enterprise', 'online']
  with_items:
  - master
  - node
  - .config_managed

- openshift_facts:
    role: "{{ item.role }}"
    local_facts: "{{ item.local_facts }}"
  with_items:
    - role: master
      local_facts:
        cluster_method: "{{ openshift_master_cluster_method | default(None) }}"
        cluster_hostname: "{{ openshift_master_cluster_hostname | default(None) }}"
        cluster_public_hostname: "{{ openshift_master_cluster_public_hostname | default(None) }}"
        debug_level: "{{ openshift_master_debug_level | default(openshift.common.debug_level) }}"
        api_port: "{{ openshift_master_api_port | default(None) }}"
        api_url: "{{ openshift_master_api_url | default(None) }}"
        api_use_ssl: "{{ openshift_master_api_use_ssl | default(None) }}"
        public_api_url: "{{ openshift_master_public_api_url | default(None) }}"
        console_path: "{{ openshift_master_console_path | default(None) }}"
        console_port: "{{ openshift_master_console_port | default(None) }}"
        console_url: "{{ openshift_master_console_url | default(None) }}"
        console_use_ssl: "{{ openshift_master_console_use_ssl | default(None) }}"
        public_console_url: "{{ openshift_master_public_console_url | default(None) }}"
        logging_public_url: "{{ openshift_master_logging_public_url | default(None) }}"
        metrics_public_url: "{{ openshift_master_metrics_public_url | default(None) }}"
        logout_url: "{{ openshift_master_logout_url | default(None) }}"
        extension_scripts: "{{ openshift_master_extension_scripts | default(None) }}"
        extension_stylesheets: "{{ openshift_master_extension_stylesheets | default(None) }}"
        extensions: "{{ openshift_master_extensions | default(None) }}"
        oauth_template: "{{ openshift_master_oauth_template | default(None) }}"
        etcd_hosts: "{{ openshift_master_etcd_hosts | default(None) }}"
        etcd_port: "{{ openshift_master_etcd_port | default(None) }}"
        etcd_use_ssl: "{{ openshift_master_etcd_use_ssl | default(None) }}"
        etcd_urls: "{{ openshift_master_etcd_urls | default(None) }}"
        embedded_etcd: "{{ openshift_master_embedded_etcd | default(None) }}"
        embedded_kube: "{{ openshift_master_embedded_kube | default(None) }}"
        embedded_dns: "{{ openshift_master_embedded_dns | default(None) }}"
        # defaults to 8053 when using dnsmasq in 1.2/3.2
        dns_port: "{{ openshift_master_dns_port | default(None) }}"
        bind_addr: "{{ openshift_master_bind_addr | default(None) }}"
        pod_eviction_timeout: "{{ openshift_master_pod_eviction_timeout | default(None) }}"
        session_max_seconds: "{{ openshift_master_session_max_seconds | default(None) }}"
        session_name: "{{ openshift_master_session_name | default(None) }}"
        session_secrets_file: "{{ openshift_master_session_secrets_file | default(None) }}"
        session_auth_secrets: "{{ openshift_master_session_auth_secrets | default(None) }}"
        session_encryption_secrets: "{{ openshift_master_session_encryption_secrets | default(None) }}"
        access_token_max_seconds: "{{ openshift_master_access_token_max_seconds | default(None) }}"
        auth_token_max_seconds: "{{ openshift_master_auth_token_max_seconds | default(None) }}"
        identity_providers: "{{ openshift_master_identity_providers | default(None) }}"
        registry_url: "{{ oreg_url | default(None) }}"
        oauth_grant_method: "{{ openshift_master_oauth_grant_method | default(None) }}"
        sdn_cluster_network_cidr: "{{ osm_cluster_network_cidr | default(None) }}"
        sdn_host_subnet_length: "{{ osm_host_subnet_length | default(None) }}"
        default_subdomain: "{{ openshift_master_default_subdomain | default(osm_default_subdomain) | default(None) }}"
        custom_cors_origins: "{{ osm_custom_cors_origins | default(None) }}"
        default_node_selector: "{{ osm_default_node_selector | default(None) }}"
        project_request_message: "{{ osm_project_request_message | default(None) }}"
        project_request_template: "{{ osm_project_request_template | default(None) }}"
        mcs_allocator_range: "{{ osm_mcs_allocator_range | default(None) }}"
        mcs_labels_per_project: "{{ osm_mcs_labels_per_project | default(None) }}"
        uid_allocator_range: "{{ osm_uid_allocator_range | default(None) }}"
        router_selector: "{{ openshift_router_selector | default(None) }}"
        registry_selector: "{{ openshift_registry_selector | default(None) }}"
        api_server_args: "{{ osm_api_server_args | default(None) }}"
        controller_args: "{{ osm_controller_args | default(None) }}"
        infra_nodes: "{{ openshift_infra_nodes | default(None) }}"
        disabled_features: "{{ osm_disabled_features | default(None) }}"
        master_count: "{{ openshift_master_count | default(None) }}"
        controller_lease_ttl: "{{ osm_controller_lease_ttl | default(None) }}"
        master_image: "{{ osm_image | default(None) }}"
        scheduler_predicates: "{{ openshift_master_scheduler_predicates | default(None) }}"
        scheduler_priorities: "{{ openshift_master_scheduler_priorities | default(None) }}"
        admission_plugin_order: "{{openshift_master_admission_plugin_order | default(None) }}"
        admission_plugin_config: "{{openshift_master_admission_plugin_config | default(None) }}"
        kube_admission_plugin_order: "{{openshift_master_kube_admission_plugin_order | default(None) }}"
        kube_admission_plugin_config: "{{openshift_master_kube_admission_plugin_config | default(None) }}"
        oauth_template: "{{ openshift_master_oauth_template | default(None) }}" # deprecated in origin 1.2 / OSE 3.2
        oauth_templates: "{{ openshift_master_oauth_templates | default(None) }}"
        oauth_always_show_provider_selection: "{{ openshift_master_oauth_always_show_provider_selection | default(None) }}"
        image_policy_config: "{{ openshift_master_image_policy_config | default(None) }}"

- openshift_facts:
    role: hosted
    openshift_env:
      openshift_hosted_registry_storage_kind: 'nfs'
  when: openshift_hosted_registry_storage_kind is not defined and openshift_nfs_hosts | default([]) | length > 0

- name: Set facts necessary for generating certificates
  set_fact:
    etcd_cert_config_dir: "{{ openshift.common.config_base }}/master"
    etcd_cert_subdir: "openshift-master-{{ openshift.common.hostname }}"
    master_cert_subdir: master-{{ openshift.common.hostname }}
    master_cert_config_dir: "{{ openshift.common.config_base }}/master"
    master_generated_certs_dir: "{{ openshift.common.config_base }}/generated-configs"
    master_hostnames: "{{ hostvars
                               | oo_select_keys(openshift_master_master_hosts)
                               | oo_collect('openshift.common.all_hostnames')
                               | oo_flatten | unique }}"

- name: Check for cached session secrets
  openshift_facts:
    role: master
    local_facts:
      session_auth_secrets: "{{ openshift_master_session_auth_secrets | default(openshift.master.session_auth_secrets | default(None)) }}"
      session_encryption_secrets: "{{ openshift_master_session_encryption_secrets | default(openshift.master.session_encryption_secrets | default(None)) }}"

- name: Generate master session secrets
  set_fact:
    g_session_secrets_present: "{{ (openshift.master.session_auth_secrets | default([]) and openshift.master.session_encryption_secrets | default([])) | length > 0 }}"
    g_session_auth_secrets: "{{ [ 24 | oo_generate_secret ] }}"
    g_session_encryption_secrets: "{{ [ 24 | oo_generate_secret ] }}"
  delegate_to: "{{ openshift_certificates_ca_host }}"
  run_once: true

- name: Persist generated session secrets
  openshift_facts:
    role: master
    local_facts:
      session_auth_secrets: "{{ hostvars[openshift_certificates_ca_host].g_session_auth_secrets }}"
      session_encryption_secrets: "{{ hostvars[openshift_certificates_ca_host].g_session_encryption_secrets }}"
  when: not hostvars[openshift_certificates_ca_host].g_session_secrets_present | bool
