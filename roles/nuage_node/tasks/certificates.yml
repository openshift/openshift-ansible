---
- name: Create a directory to hold the certificates
  file: path="{{ nuage_plugin_rest_client_crt_dir }}" state=directory
  delegate_to: "{{ nuage_ca_master }}"

- name: Create the key
  command: >
    openssl genrsa -out "{{ nuage_ca_master_plugin_key }}" 4096  
  delegate_to: "{{ nuage_ca_master }}"

- name: Create the req file
  command: >
    openssl req -key "{{ nuage_ca_master_plugin_key }}" -new -out "{{ nuage_plugin_rest_client_crt_dir }}/restClient.req" -subj "/CN=nuage-client"
  delegate_to: "{{ nuage_ca_master }}"

- name: Generate the crt file
  command: >
     openssl x509 -req -in "{{ nuage_plugin_rest_client_crt_dir }}/restClient.req" -CA "{{ nuage_ca_crt }}" -CAkey "{{ nuage_ca_key }}" -CAserial "{{ nuage_ca_serial }}"  -out "{{ nuage_ca_master_plugin_crt }}" -extensions clientauth -extfile "{{ nuage_ca_dir }}"/openssl.cnf 
  delegate_to: "{{ nuage_ca_master }}"

- name: Remove the req file
  file: path="{{ nuage_plugin_rest_client_crt_dir }}/restClient.req" state=absent
  delegate_to: "{{ nuage_ca_master }}"

- name: Copy the CA certificate
  synchronize: mode=push src="{{ nuage_ca_crt }}" dest="{{ nuage_plugin_crt_dir }}/nuageMonCA.crt"
  delegate_to: "{{ nuage_ca_master }}" 

- name: Copy the plugin certificate and key
  synchronize: mode=push src="{{ nuage_plugin_rest_client_crt_dir }}/{{ item }}" dest="{{ nuage_plugin_crt_dir }}/{{ item }}"
  with_items:
    - nuageMonClient.key
    - nuageMonClient.crt
  delegate_to: "{{ nuage_ca_master }}"

- name: Delete the certificates after copy
  file: path="{{ nuage_plugin_rest_client_crt_dir }}/{{ item }}" state=absent 
  with_items:
    - nuageMonClient.key
    - nuageMonClient.crt
  delegate_to: "{{ nuage_ca_master }}"
