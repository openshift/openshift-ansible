---
- name: Set nodelabel OpenShift facts
  set_fact:
      infranode_label: "{{ ocom_infra_node_label | default(openshift.common.infranode_label) }}"

- name: Get Nodes Config
  shell: osc get nodes -o json | sed -e '/"resourceVersion"/d'
  register: output

- name: Set node_facts
  set_fact:
    node_facts: "{{ output.stdout | from_json }}"

- name: Get Node Lists
  set_fact:
    compute_hostvars: "{{ hostvars | oo_select_keys(groups['oo_nodes_to_config']) }}"
    infra_hostvars:  "{{ hostvars | oo_select_keys(groups['oo_infra_to_config']) }}"

- name: Set compute node regions
  set_fact:
    node_facts: "{{ node_facts | oo_set_node_region(oln_node_region, compute_hostvars) }}"

- name: Set infra node labels
  set_fact:
    node_facts: "{{ node_facts | oo_set_node_region(infranode_label, infra_hostvars) }}"

- name: Write node config to temp file
  copy:
    content: "{{ node_facts }}"
    dest: /tmp/nodes.json

- name: Import new node config
  shell: osc update node -f /tmp/nodes.json

- name: Remove node temp file
  file:
    path: /tmp/nodes.json
    state: absent
