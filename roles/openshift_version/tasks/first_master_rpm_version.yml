---
# If provided, openshift_pkg_version is preferred over openshift_release
- name: Set rpm version to configure if openshift_pkg_version specified
  set_fact:
    # Expects a leading "-" in inventory, strip it off here, and remove trailing release,
    openshift_version: "{{ openshift_pkg_version[1:].split('-')[0] }}"
  when:
  - openshift_pkg_version is defined
  - openshift_pkg_version != ""
  - openshift_version is not defined or openshift_version_reinit | bool

- name: Set rpm version to configure if openshift_release specified
  set_fact:
    openshift_version: "{{ openshift_release }}"
  when:
  - openshift_release is defined
  - openshift_pkg_version is not defined or openshift_pkg_version == ""
  - openshift_version is not defined or openshift_version_reinit | bool

- name: Check for available RPMs
  include_tasks: check_available_rpms.yml

# Fall back to the rpm package found in configured repositories
- name: Set openshift_version to rpm version found
  set_fact:
    openshift_version: "{{ rpm_results.results.versions.available_versions.0 }}"
  when:
  - openshift_version is not defined or (openshift_version is defined and openshift_version.split('.') | length == 2)

- name: Set openshift_pkg_version to rpm version found if openshift_pkg_version was not specified
  set_fact:
    openshift_pkg_version: "-{{ rpm_results.results.versions.available_versions.0 }}"
  when: >
    openshift_pkg_version is not defined or openshift_pkg_version == ""
    or (openshift_pkg_version is defined and openshift_pkg_version.split('.') | length == 2)

- name: Set openshift_image_tag to match openshift_version
  set_fact:
    openshift_image_tag: v{{ openshift_version }}
  when: >
    openshift_image_tag is not defined or openshift_image_tag == ""
    or openshift_version not in openshift_image_tag
