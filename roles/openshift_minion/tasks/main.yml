---
# tasks file for openshift_minion

  # fixme: Once openshift stops resolving hostnames for minion queries remove this...
- name: Set hostname to IP Addr (WORKAROUND)
  hostname: name={{ oo_bind_ip }}

- name: Update the nb_minons local fact on all the minions
  lineinfile:
    dest: /etc/ansible/facts.d/minion.fact
    regexp: '^nb_minions'
    line: "nb_minions={{ hostvars | oo_select_keys( groups[ 'tag_env-host-type_' + oo_env + '-openshift-minion' ] ) | oo_collect('ansible_local') | oo_collect('minion') | oo_collect('minion') | oo_collect('nb_minions') | map('int') | max }}"

- include: openshift_from_yum.yml
  when: oo_openshift_binary is not defined

- include: openshift_from_local.yml
  when: oo_openshift_binary is defined

- name: Configure OpenShift Minion settings
  lineinfile: >
    dest=/etc/sysconfig/openshift
    create=yes
    regexp={{ item.regex }}
    line="{{ item.line }}"
  with_items:
    - { regex: '^ROLE=', line: 'ROLE=\"node\"' }
    - { regex: '^OPTIONS=', line: 'OPTIONS=\"--master=http://{{ oo_master_ips[0] }}:8080  --loglevel=5\"' }
  notify:
    - restart openshift-minion

- name: Open firewalld port for OpenShift
  firewalld: port=10250/tcp permanent=false state=enabled

- name: Save firewalld port for OpenShift
  firewalld: port=10250/tcp permanent=true state=enabled

- name: Enable OpenShift
  service: name=openshift enabled=yes state=started
