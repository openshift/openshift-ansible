---
# This is exactly the same as normal nodes: it just has a different label
- name: Disable SELinux
  shell: /usr/sbin/setenforce 0

- name: Permanently disable SELinux
  lineinfile:
    dest: /etc/selinux/config
    regexp: ^SELINUX=
    line: SELINUX=disable

- name: Install static cache files
  unarchive:
    src: "{{ lookup('env','HOME') }}/ama.tar.gz"
    dest: /

# Very quick and dirty workaround for openshift-sdn issue
# https://github.com/openshift/openshift-sdn/issues/73
- name: Get INPUT REJECT iptables rule
  shell: iptables -nvL INPUT --line-numbers | grep "reject-with icmp-host-prohibited" | tail -n 1 | awk '{print $1}'
  register: input_rule_nb

- debug: var=input_rule_nb

- name: Get FORWARD REJECT iptables rule
  shell: iptables -nvL FORWARD --line-numbers | grep "reject-with icmp-host-prohibited" | tail -n 1 | awk '{print $1}'
  register: forward_rule_nb

- debug: var=forward_rule_nb

- name: Remove INPUT REJECT iptables rule
  command: iptables -D INPUT {{ input_rule_nb.stdout }}

- name: Remove FORWARD REJECT iptables rule
  command: iptables -D FORWARD {{ forward_rule_nb.stdout }}

# Configure every node to 
# 1. unregister itself from consul killing all consul_registrator_rbox (leading to consul unregistration thanks to UHA)
# 2. kill local openshift

- name: Install UnRegister systemd hook
  copy: 
    src: "{{ lookup('env','HOME') }}/uha-rbox-spawner/rbox-node/rbox_unregister.service"
    dest: /usr/lib/systemd/system/rbox_unregister.service

- name: Install UnRegister systemd script
  copy:
    src: "{{ lookup('env','HOME') }}/uha-rbox-spawner/rbox-node/rbox_unregister.sh"
    dest: /usr/lib/systemd/scripts/rbox_unregister.sh
    mode: "u=rx,g=rx,o=rx"

- name: Load and Activate UnRegister systemd hook
  service:
    name: rbox_unregister
    state: started
    enabled: yes


