---
- command: >
    {{ openshift.common.client_binary }} -n {{ openshift_metrics_project | quote }}
    --config={{ mktemp.stdout }}/admin.kubeconfig
    get rc hawkular-metrics -o jsonpath='{.spec.replicas}'
  register: hawkular_metrics_replica_count
  failed_when: false
  changed_when: false

- name: generate hawkular-metrics replication controller
  template:
    src: hawkular_metrics_rc.j2
    dest: "{{ mktemp.stdout }}/templates/hawkular_metrics_rc.yaml"
  vars:
    replica_count: "{{hawkular_metrics_replica_count.stdout | default(0)}}"
    node_selector: "{{openshift_metrics_hawkular_nodeselector | default('') }}"
  changed_when: false

- name: read hawkular-metrics route destination ca certificate
  slurp: src={{ mktemp.stdout }}/ca.crt
  register: metrics_route_dest_ca_cert
  changed_when: false

- name: Hawkular Role to read secrets
  oc_clusterrole:
    name: hawkular-reads-logging-ca-cert
    rules:
    - apiGroups:
      - ""
      verbs:
      - get
      resources:
      - secrets

## TODO: how to restrict this to allow the user 'hawkular' to read only a very specific secret?
## For now, generic (and dangerous), but make sure to change this before getting this merged
- name: Allow Hawkular to read the Logging CA cert secret
  oc_adm_policy_user:
    user: system:serviceaccount:{{openshift_metrics_project}}:hawkular
    resource_kind: cluster-role
    resource_name: hawkular-reads-logging-ca-cert
    state: present

## TODO: cluster-admin can read stuff from Elasticsearch. Until they add a more appropriate role,
## we have to use this.
- name: Allow Hawkular to access Elasticsearch on logging
  oc_adm_policy_user:
    user: hawkular
    resource_kind: cluster-role
    resource_name: cluster-admin
    state: present

- block:
  - set_fact: hawkular_key={{ lookup('file', openshift_metrics_hawkular_key) }}
    when: openshift_metrics_hawkular_key | exists
    changed_when: false

  - set_fact: hawkular_cert={{ lookup('file', openshift_metrics_hawkular_cert) }}
    when: openshift_metrics_hawkular_cert | exists
    changed_when: false

  - set_fact: hawkular_ca={{ lookup('file', openshift_metrics_hawkular_ca) }}
    when: openshift_metrics_hawkular_ca | exists
    changed_when: false

  - name: generate the hawkular-metrics route
    template:
      src: route.j2
      dest: "{{ mktemp.stdout }}/templates/hawkular-metrics-route.yaml"
    vars:
      name: hawkular-metrics
      labels:
        metrics-infra: hawkular-metrics
      host: "{{ openshift_metrics_hawkular_hostname }}"
      to:
        kind: Service
        name: hawkular-metrics
      tls:
        termination: reencrypt
        key: "{{ hawkular_key | default('') }}"
        certificate: "{{ hawkular_cert | default('') }}"
        ca_certificate: "{{ hawkular_ca | default('') }}"
        destination_ca_certificate: "{{ metrics_route_dest_ca_cert.content | b64decode }}"
    changed_when: false
