---
# TODO -- this may actually work on atomic hosts
- fail:
    msg: "openshift_storage_nfs_lvm is not compatible with atomic host"
  when: openshift_is_atomic | bool

- name: Create lvm volumes
  lvol: vg={{r_openshift_storage_nfs_lvm_volume_group}} lv={{ item }} size={{r_openshift_storage_nfs_lvm_volume_size}}G
  with_sequence: start={{r_openshift_storage_nfs_lvm_volume_num_start}} count={{r_openshift_storage_nfs_lvm_volume_count}} format={{r_openshift_storage_nfs_lvm_volume_prefix}}{{r_openshift_storage_nfs_lvm_volume_size}}g%04d

- name: create filesystem
  filesystem: fstype=xfs dev=/dev/{{r_openshift_storage_nfs_lvm_volume_group}}/{{ item }}
  with_sequence: start={{r_openshift_storage_nfs_lvm_volume_num_start}} count={{r_openshift_storage_nfs_lvm_volume_count}} format={{r_openshift_storage_nfs_lvm_volume_prefix}}{{r_openshift_storage_nfs_lvm_volume_size}}g%04d

- name: mount volumes
  mount: name={{r_openshift_storage_nfs_lvm_mount_dir}}/{{ item }} src=/dev/{{r_openshift_storage_nfs_lvm_volume_group}}/{{ item }} state=mounted fstype=xfs passno=0
  with_sequence: start={{r_openshift_storage_nfs_lvm_volume_num_start}} count={{r_openshift_storage_nfs_lvm_volume_count}} format={{r_openshift_storage_nfs_lvm_volume_prefix}}{{r_openshift_storage_nfs_lvm_volume_size}}g%04d

- name: Make mounts owned by nfsnobody
  file: path={{r_openshift_storage_nfs_lvm_mount_dir}}/{{ item }} owner=nfsnobody group=nfsnobody mode={{r_openshift_storage_nfs_lvm_export_dir_mode}}
  with_sequence: start={{r_openshift_storage_nfs_lvm_volume_num_start}} count={{r_openshift_storage_nfs_lvm_volume_count}} format={{r_openshift_storage_nfs_lvm_volume_prefix}}{{r_openshift_storage_nfs_lvm_volume_size}}g%04d

- include_tasks: nfs.yml

- name: Create volume json file
  template: src=../templates/nfs.json.j2 dest=/root/persistent-volume.{{ item }}.json
  with_sequence: start={{r_openshift_storage_nfs_lvm_volume_num_start}} count={{r_openshift_storage_nfs_lvm_volume_count}} format={{r_openshift_storage_nfs_lvm_volume_prefix}}{{r_openshift_storage_nfs_lvm_volume_size}}g%04d

# TODO - Get the json files to a master, and load them.
