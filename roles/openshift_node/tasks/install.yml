---
- name: Install openshift support packages
  package:
    name: "{{ openshift_node_support_packages | join(',') }}"
    state: latest
    update_cache: true
  async: 3600
  poll: 30
  register: result
  until: result is succeeded

# FIXME: Creation of these directories should not be required for crio 1.16+
- name: Create CNI dirs for crio
  file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: 0755
  loop:
  - /var/lib/cni/bin
  - /etc/kubernetes/cni/net.d/
  - /opt/cni/bin/
  - /usr/share/containers/oci/hooks.d

- name: Get cluster version
  command: >
    oc get clusterversion
    --config={{ openshift_node_kubeconfig_path }}
    --output=jsonpath='{.items[0].status.desired.version}'
  delegate_to: localhost
  register: oc_get
  until:
  - oc_get.stdout is defined
  - oc_get.stdout != ''

- name: Set fact l_cluster_version
  set_fact:
    l_cluster_version: "{{ oc_get.stdout | regex_search('^\\d+\\.\\d+') }}"

- name: Override cluster version when running CI
  set_fact:
    l_cluster_version: "*"
  when: ci_version_override | default(false) | bool == true

- name: Get kubernetes server version
  command: >
    oc version
    --config={{ openshift_node_kubeconfig_path }}
    --output=json
  delegate_to: localhost
  register: oc_get
  until:
  - oc_get.stdout is defined
  - oc_get.stdout != ''

- name: Set fact kubernetes_major_version
  set_fact:
    kubernetes_major_version: "{{ (oc_get.stdout | from_json).serverVersion.major }}"

- name: Set fact kubernetes_minor_version
  set_fact:
    kubernetes_minor_version: "{{ (oc_get.stdout | from_json).serverVersion.minor | regex_search('^\\d+') }}"

- block:
  - name: Install openshift packages
    package:
      name: "{{ openshift_node_packages | join(',') }}"
      state: latest
    async: 3600
    poll: 30
    register: result
    until: result is succeeded

  rescue:
  - name: Package install failure message
    fail:
      msg: >
        Unable to install {{ openshift_node_packages | join(', ') }}.
        Please ensure repos are configured properly to provide these packages
        and indicated versions.

- name: Enable the CRI-O service
  systemd:
    name: "crio"
    enabled: yes
