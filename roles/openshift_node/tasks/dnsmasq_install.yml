---
- name: Check for NetworkManager service
  command: >
    systemctl show NetworkManager
  register: nm_show
  changed_when: false
  ignore_errors: True

- name: Set fact using_network_manager
  set_fact:
    network_manager_active: "{{ True if 'ActiveState=active' in nm_show.stdout else False }}"

- when: not openshift_is_atomic | bool
  block:
  - name: Install dnsmasq
    package:
      name: dnsmasq
      state: installed
    register: result
    until: result is succeeded
  # This works around https://bugzilla.redhat.com/show_bug.cgi?id=1550582
  - name: Restart dbus and systemd-logind
    shell: >
      systemctl restart dbus systemd-logind && echo "done" > /tmp/openshift-ansible-dbus-restart.result
    async: 60
    poll: 0
    when: result | changed

  - name: Poll for restart finished file
    stat:
      path: /tmp/openshift-ansible-dbus-restart.result
    # We don't become here because become will timeout if systemd-logind is
    # not responding yet.
    become: False
    register: dbus_restart_results
    until: dbus_restart_results.stat.exists
    retries: 30
    when: result | changed

  - name: Cleanup temporary dbus restart script files
    file:
      path: /tmp/openshift-ansible-dbus-restart.result
      state: absent
    when: result | changed
# End block

- name: ensure origin/node directory exists
  file:
    state: directory
    path: "{{ item }}"
    owner: root
    group: root
    mode: '0700'
  with_items:
  - /etc/origin
  - /etc/origin/node

# Relies on ansible in order to configure static config
- import_tasks: dnsmasq/no-network-manager.yml
  when: not network_manager_active | bool
