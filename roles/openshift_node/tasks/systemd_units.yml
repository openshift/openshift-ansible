---
# This file is included both in the openshift_master role and in the upgrade
# playbooks.

- include: config/install-node-deps-docker-service-file.yml
  when: r_openshift_node_is_containerized | bool

- block:
  - name: Pre-pull node image
    command: >
      docker pull {{ r_openshift_node_image }}:{{ r_openshift_node_image_tag }}
    register: pull_result
    changed_when: "'Downloaded newer image' in pull_result.stdout"

  - include: config/install-node-docker-service-file.yml
  when:
  - r_openshift_node_is_containerized | bool
  - not r_openshift_node_is_node_system_container | bool

- name: Install Node service file
  template:
    dest: "/etc/systemd/system/{{ r_openshift_node_service_type }}-node.service"
    src: "node.service.j2"
  when: not r_openshift_node_is_containerized | bool
  notify:
  - reload systemd units
  - restart node

- include: config/install-ovs-service-env-file.yml
  when: r_openshift_node_is_containerized | bool

- name: Install Node system container
  include: node_system_container.yml
  when:
  - r_openshift_node_is_containerized | bool
  - r_openshift_node_is_node_system_container | bool

- name: Install OpenvSwitch system containers
  include: openvswitch_system_container.yml
  when:
  - r_openshift_node_use_openshift_sdn | bool
  - r_openshift_node_is_containerized | bool
  - r_openshift_node_is_openvswitch_system_container | bool

- include: config/workaround-bz1331590-ovs-oom-fix.yml
  when: r_openshift_node_use_openshift_sdn | bool

- block:
  - name: Pre-pull openvswitch image
    command: >
      docker pull {{ r_openshift_node_ovs_image }}:{{ r_openshift_node_image_tag }}
    register: pull_result
    changed_when: "'Downloaded newer image' in pull_result.stdout"

  - include: config/install-ovs-docker-service-file.yml
  when:
  - r_openshift_node_is_containerized | bool
  - r_openshift_node_use_openshift_sdn | bool
  - not r_openshift_node_is_openvswitch_system_container | bool

- include: config/configure-node-settings.yml
- include: config/configure-proxy-settings.yml
