#!/usr/bin/env python

import click
from glob import glob
import graphviz as gv
import os
import sys
import yaml
import random

''' Generate a directed graph of ansible role dependencies.

    Usage: ./ansible-role-graph --format pdf --engine dot --roles-path ~/openshift-ansible/roles/
'''

@click.command()
@click.option('--format', '-f', 'output_format',
              default='pdf', type=click.Choice(['pdf', 'png', 'svf']),
              help=('The output format to use. Default: pdf'))
@click.option('--engine', '-e',
              default='dot', type=click.Choice(['dot', 'fdp', 'sfdp']),
              help=('The graphviz engine type. Default: dot'))
@click.option('--colorize', '-c', is_flag=True,
              help='Colorize dep chains on a role by role basis')
@click.option('--show/--dont-show', '-s/-n', 'show',
              default=True,
              help='Open the generated graph. Graph will be opened by default.')
@click.option('--roles-path', '-r', 'roles_path',
              default='./roles/',
              help='Path to ansible roles directory. Defaults to "./roles/"')
@click.help_option('--help', '-h')
def generate_role_graph(output_format, engine, colorize, show, roles_path):
    dot = gv.Digraph(engine=engine, format=output_format)
    dot.attr('node', fontname='Helvetica')
    dot.body.append(r'label = "\n\nOpenShift-Ansible Role Dep Chains"')
    dot.body.append(r'fontname = "Helvetica"')
    dot.body.append('fontsize=20')

    meta_files = glob(os.path.abspath(roles_path) + '/*/meta/main.yml')
    if len(meta_files) == 0:
        print("Unable to locate roles within {0}".format(os.path.abspath(roles_path)))
        sys.exit(1)

    for path in meta_files:
        dependent_role = path.split('roles')[1].split('/')[1]
        dot.node(dependent_role)
        with open(path, 'r') as f:
            meta_config = yaml.load(f.read())
            if 'dependencies' in meta_config:
                i = random.randrange(1, 10)
                for dependency in meta_config['dependencies']:
                    if 'role' in dependency:
                        depended_role = dependency['role']
                    else:
                        depended_role = dependency
                    dot.node(depended_role)
                    if colorize:
                        # Colors from: http://www.graphviz.org/doc/info/colors.html#brewer
                        # Random color 'i' per dep chain
                        attrs = {'color': "/paired10/%s" % i}
                    else:
                        attrs = {}
                    dot.edge(dependent_role, depended_role, **attrs)

    if not show:
        print(("Generated graph. "
               "Open with: xdg-open generated-ansible-role-graph.{0}".format(output_format)))

    dot.render('generated-ansible-role-graph', view=show)

if __name__ == '__main__':
    generate_role_graph()
